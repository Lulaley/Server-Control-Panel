<!doctype html>
<html lang="fr">
<head>
    {% include 'head.html' %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/games.css') }}">
</head>
<body>
  {% include 'navbar.html' %}
  <main class="container">
    {% if True %}
      {% if machine_info is defined %}
        {% set m = machine_info %}
      {% elif machine is defined %}
        {% set m = machine %}
      {% elif host is defined %}
        {% set m = host %}
      {% else %}
        {% set m = None %}
      {% endif %}
      <style>
        .machine-card{
          padding:16px;
          border-radius:10px;
          background:linear-gradient(180deg,#ffffff,#fbfdff);
          border:1px solid rgba(16,24,40,0.06);
          box-shadow:0 8px 22px rgba(16,24,40,0.06);
          margin-right:16px;
          font-family:inherit;
          color:#0f172a;
          display:flex;
          flex-direction:column;
        }
        .machine-card h4{
          margin:0;
          font-size:15px;
          font-weight:600;
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:8px;
        }
        .machine-card h4 .small{
          font-size:12px;
          color:#64748b;
          font-weight:500;
        }
        .machine-card .metric{
          display:flex;
          align-items:center;
          justify-content:space-between;
          gap:12px;
          padding:6px 0;
          font-size:13px;
        }
        .machine-card .metric .label{
          min-width:60px;
          color:#334155;
        }
        .metric-info{
          flex:1;
          display:flex;
          align-items:center;
          gap:12px;
        }
        .metric .value{
          min-width:80px;
          text-align:right;
          color:#0b1220;
          font-weight:600;
        }
        .progress{
          flex:1;
          height:10px;
          background:#eef2f7;
          border-radius:999px;
          overflow:hidden;
        }
        .progress > i{
          display:block;
          height:100%;
          width:0%;
          border-radius:999px;
          transition:width .6s ease, background .3s ease;
        }
        .status-green{color:#1b7a1b}
        .status-warning{color:#b26900}
        .status-danger{color:#c62828}
        @media (max-width:800px){
          .machine-card{max-width:100%;margin-bottom:12px;float:none}
        }

        /* centre l'image de la page */
        .page-hero{
          display:flex;
          justify-content:center;
          align-items:center;
          margin:18px 0;
        }
        .page-hero img{
          width:10%;
          max-width:140px;
          height:auto;
          display:block;
        }
      </style>

      <aside id="machine-card" class="machine-card" aria-label="Informations machine">
        <h4>Machine <span class="small">État système</span></h4>

        <div class="metric">
          <span class="label">CPU</span>
          <div class="metric-info">
            <div class="value" id="cpu-value">
              {% if m and m.cpu_percent is not none %}{{ m.cpu_percent }}%{% else %}<em>—</em>{% endif %}
            </div>
            {% if m and m.cpu_percent is not none %}
              <div class="progress" aria-hidden="true">
                <i class="progress-bar" data-metric="cpu" style="width:{{ m.cpu_percent }}%; background:{% if m.cpu_percent < 60 %}#1b7a1b{% elif m.cpu_percent < 85 %}#b26900{% else %}#c62828{% endif %};"></i>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="metric">
          <span class="label">RAM</span>
          <div class="metric-info">
            <div class="value" id="ram-value">
              {% if m and m.ram_used is defined and m.ram_total is defined and m.ram_percent is not none %}
                {{ m.ram_used }} / {{ m.ram_total }} ({{ m.ram_percent }}%)
              {% elif m and m.ram_percent is not none %}
                {{ m.ram_percent }}%
              {% else %}
                <em>—</em>
              {% endif %}
            </div>
            {% if m and m.ram_percent is not none %}
              <div class="progress" aria-hidden="true">
                <i class="progress-bar" data-metric="ram" style="width:{{ m.ram_percent }}%; background:{% if m.ram_percent < 60 %}#1b7a1b{% elif m.ram_percent < 85 %}#b26900{% else %}#c62828{% endif %};"></i>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="metric">
          <span class="label">Disque</span>
          <div class="metric-info">
            <div class="value" id="disk-value">
              {% if m and m.disk_used is defined and m.disk_total is defined and m.disk_percent is not none %}
                {{ m.disk_used }} / {{ m.disk_total }} ({{ m.disk_percent }}%)
              {% elif m and m.disk_percent is not none %}
                {{ m.disk_percent }}%
              {% else %}
                <em>—</em>
              {% endif %}
            </div>
            {% if m and m.disk_percent is not none %}
              <div class="progress" aria-hidden="true">
                <i class="progress-bar" data-metric="disk" style="width:{{ m.disk_percent }}%; background:{% if m.disk_percent < 60 %}#1b7a1b{% elif m.disk_percent < 85 %}#b26900{% else %}#c62828{% endif %};"></i>
              </div>
            {% endif %}
          </div>
        </div>
      </aside>
    {% endif %}
    <br>
    <h1 class="page-hero"><img src="{{ url_for('static', filename='images/services.png') }}" alt="Serveurs"></h1>
    {% for game, servers in groups.items() %}
      <section class="game-group">
        <h2 class="group-title">{{ game|capitalize }}</h2>
        <div class="cards">
          {% if servers %}
            {% for s in servers %}
              <article class="server-card">
                <div class="card-header">
                  <h3>{{ s.name }}</h3>
                  <span class="status {% if s.status in ['online','running','active'] %}online{% elif s.status in ['offline','stopped','inactive'] %}offline{% else %}unknown{% endif %}">{{ s.status or 'unknown' }}</span>
                </div>
                <div class="card-body">
                  <p class="address">
                    {% if s.host and s.port %}
                      {{ s.host }}:{{ s.port }}
                    {% elif s.host %}
                      {{ s.host }}
                    {% elif s.port %}
                      {{ s.port }}
                    {% else %}
                      <em>{{ s.id or '—' }}</em>
                    {% endif %}
                  </p>
                  <p class="last-log"><strong>Dernière ligne de log:</strong>
                    {% if s.last_log %}
                      <span>{{ s.last_log }}</span>
                    {% else %}
                      <em>indisponible</em>
                    {% endif %}
                  </p>
                </div>
                <div class="card-actions">
                  {# Ouvre la page du jeu correspondant avec le service déjà sélectionné #}
                  <a class="btn-open" href="/{{ game }}?server={{ s.id }}" target="_blank">Ouvrir</a>
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty">Aucun serveur pour ce jeu.</p>
          {% endif %}
        </div>
      </section>
    {% endfor %}
  </main>
  <script src="{{ url_for('static', filename='js/games.js') }}"></script>
  <script src="{{ url_for('static', filename='js/machine-card.js') }}"></script>

    <!-- ensure sticky machine-card isn't hidden behind navbar -->
    <script>
      (function(){
        const card = document.getElementById('machine-card');
        if(!card) return;
        function updateTop(){
          const nav = document.querySelector('nav, .navbar, #navbar');
          const offset = nav ? (nav.offsetHeight + 8) : 80;
          card.style.top = offset + 'px';
        }
        updateTop();
        window.addEventListener('resize', updateTop);
        const navEl = document.querySelector('nav, .navbar, #navbar');
        if(navEl) new MutationObserver(updateTop).observe(navEl, {subtree:true, childList:true, attributes:true});
      })();
    </script>

    {% include 'footer.html' %}
</body>
</html>
